<!DOCTYPE html>
<html>

<head>
    <link rel="stylesheet" type="text/css" href="../../lib/css/fancytree/ui.fancytree.min.css" />
    <link rel="stylesheet" type="text/css" href="../../css/adapter.css" />
    <link rel="stylesheet" type="text/css" href="../../lib/css/materialize.css">
    <script type="text/javascript" src="../../lib/js/jquery-3.2.1.min.js"></script>
    <script type="text/javascript" src="../../lib/js/jquery-ui-1.10.3.full.min.js"></script>

    <script type="text/javascript" src="../../socket.io/socket.io.js"></script>

    <script type="text/javascript" src="../../js/translate.js"></script>
    <script type="text/javascript" src="../../lib/js/colResizable-1.5.min.js"></script>
    <script type="text/javascript" src="../../lib/js/jquery.fancytree-all.min.js"></script>
    <script type="text/javascript" src="../../lib/js/selectID.js"></script>
    <script type="text/javascript" src="../../lib/js/materialize.js"></script>
    <script type="text/javascript" src="../../js/adapter-settings.js"></script>
    <script type="text/javascript" src="words.js"></script>

    <script type="text/javascript" src="ext/metroui/js/metro.min.js"></script>
    <link rel="stylesheet" type="text/css" href="ext/metroui/css/metro.min.css" />
    <link rel="stylesheet" type="text/css" href="ext/metroui/css/metro-icons.min.css" />
    <link rel="stylesheet" type="text/css" href="ext/metroui/css/metro-colors.min.css" />
    <link rel="stylesheet" type="text/css" href="css/yahka.admin.css" />

    <script type="text/javascript" src="yahka.admin.js"></script>
    <script type="text/javascript" src="words.js"></script>
    <style>
        .dialog-select-member-close {
        text-align: center;
        position: absolute;
        z-index: 1;
        border: 1px solid #124967;
        border-radius: 3px;
        top: 3px;
        right: 3px;
        width: 20px;
        height: 20px;
        background: rgb(206, 53, 44);
        color: white;
        font-weight: bold;
        cursor: pointer;
    }
</style>
    <script type="text/javascript">
        var yahkaAdmin = new yahkaAdmin.ioBroker_YahkaAdmin();
        var objects = null;
        var onChange;

        var $selectId;

        function initSelectidHelper(_objects) {
            return $('#dialog-select-member').selectId('init', {
                noMultiselect: true,
                noDialog: false,
                objects: _objects,
                imgPath: '../../lib/css/fancytree/',
                filter: { type: 'state' },
                name: 'vcard-select-state',
                texts: {
                    select: _('Select'),
                    cancel: _('Cancel'),
                    all: _('All'),
                    id: _('ID'),
                    name: _('Name'),
                    role: _('Role'),
                    room: _('Room'),
                    value: _('Value'),
                    selectid: _('Select ID'),
                    from: _('From'),
                    lc: _('Last changed'),
                    ts: _('Time stamp'),
                    wait: _('Processing...'),
                    ack: _('Acknowledged'),
                    selectAll: _('Select all'),
                    unselectAll: _('Deselect all'),
                    invertSelection: _('Invert selection')
                },
                columns: ['image', 'name', 'role', 'room']
            });
        }

        function getObjects(callback) {
            if (objects) {
                callback && callback(objects);
            } else {
                socket.emit('getObjects', function (err, res) {
                    objects = res || {};
                    callback && callback(objects);
                });
            }
        }

        function initSelectId(cb) {
            if ($selectId) return cb($selectId);
            getObjects(function () {
                $selectId = initSelectidHelper(objects);
                cb && cb($selectId);
            });
        }

        function load(settings, _onChange) {
            onChange = _onChange;
            $('body').on('click', '.id-selector', function () {
                // get input
                var $textarea = $(this).parent().parent().find('textarea');
                var $select = $(this).parent().parent().find('select');
                initSelectId(function ($sid) {
                    $sid.selectId('show', $textarea.val(), function (newId) {
                        $sid.hide();
                        if (newId !== $textarea.val()) {
                            $textarea.val(newId)[0].dispatchEvent(new Event('input'));
                            //if (!$select.val()) {
                            //    $select.val('ioBroker.State')[0].dispatchEvent(new Event('input'));
                            //}
                        }
                    }).show();

                    if (!$sid.find('.dialog-select-member-close').length) {
                        $sid.append('<div class="dialog-select-member-close">x</div>');
                        $sid.find('.dialog-select-member-close').click(function () {
                            $sid.hide();
                        });
                    }
                });
            });

            yahkaAdmin.loadSettings(settings, _onChange);
        }

        function save(callback) {
            yahkaAdmin.saveSettings(callback)
        }
    </script>
</head>

<body>

    <div id="adapter-container" class="flex-container-col">
        <div>
            <img src="yahka.png" />
            <h3 class="translate" style="display: inline; vertical-align: middle;">iobroker.yahka adapter settings</h3>
            <div class="translate" data-lang="ConfigDescription" style="display: inline-block">The page below is used
                to assign ioBroker states to HomeKit characteristics.</div>
        </div>

        <div class="flex-grow flex-container-col bg-white" id="yahka_bridge_frame">
            <div class="flex-container-row flex-grow">
                <div class="flex-grow flex-panel">
                    <div>
                        <button class="image-button primary" id="yahka_add_device">
                            <span class="icon mif-plus bg-darkCobalt  fg-white"></span>
                            <span class="translate">Add Device</span>
                        </button>
                        <button class="image-button primary" id="yahka_add_camera">
                            <span class="icon mif-plus bg-darkCobalt  fg-white"></span>
                            <span class="translate">Add Camera</span>
                        </button>
                        <button class="image-button danger" id="yahka_remove_device">
                            <span class="icon mif-minus bg-darkCrimson  fg-white"></span>
                            <span class="translate">Remove Device</span>
                        </button>
                        <button class="image-button primary" id="yahka_duplicate_device">
                            <span class="icon mif-plus bg-darkCobalt  fg-white"></span>
                            <span class="translate">Duplicate Device</span>
                        </button>
                        <button class="image-button primary" id="yahka_add_service">
                            <span class="icon mif-plus bg-darkCobalt  fg-white"></span>
                            <span class="translate">Add Service</span>
                        </button>

                    </div>
                </div>
            </div>

            <div class="flex-grow treeAndData flex-container-row">
                <div class="flex-panel" style="min-width: 20%">
                    <div class="caption translate">Devices</div>
                    <div class="listview" id="yahka_deviceList">
                    </div>
                </div>
                <div class=" flex-grow flex-panel">
                    <div class="caption translate">Properties and Services</div>
                    <div class="accordion" id="yahka_device_details" data-role="accordion">
                    </div>
                </div>
            </div>
        </div>

        <template id="yahka_devicelist_entry">
            <div class="list device-entry">
                <span class="icon list-icon"></span>
                <span class="list-title"> </span>
            </div>
        </template>

        <template id="yahka_device_info_panel_template">
            <div class="frame" id="yahka_device_info_panel">
                <div class="heading">
                    <span class="translate">Device Properties</span>
                </div>

                <div class="content">
                    <div>
                        <div><label class="translate" for="enabled">Enabled:</label></div>
                        <div class="input control flex-grow margin10">
                            <input type="checkbox" id="enabled" />
                        </div>
                    </div>
                    <div>
                        <div><label class="translate" for="name">Name:</label></div>
                        <div class="errorpanel translate" id="name_error">A device with this name already exists.
                            Please change the name!</div>
                        <div class="input control flex-grow margin10">
                            <input class="full-size" type="text" id="name" />
                        </div>
                    </div>
                    <div>
                        <div><label class="translate" for="manufacturer">Manufacturer:</label></div>
                        <div class="input control flex-grow  margin10">
                            <input class="full-size" type="text" id="manufacturer" />
                        </div>
                    </div>
                    <div>
                        <div><label class="translate" for="model">Model:</label></div>
                        <div class="input controlflex-grow  margin10">
                            <input class="full-size" type="text" id="model" />
                        </div>
                    </div>
                    <div>
                        <div><label class="translate" for="serial">Serial:</label></div>
                        <div class="input controlflex-grow  margin10">
                            <input class="full-size" type="text" id="serial" />
                        </div>
                    </div>
                    <div>
                        <div><label class="translate" for="category">Categeory:</label></div>
                        <div class="input controlflex-grow  margin10">
                            <select class="full-size" id="category"></select>
                        </div>
                    </div>
                </div>

            </div>
        </template>

        <template id="yahka_bridgeconfig_template">
            <div>
                <div><label class="translate" for="name">Name:</label><span class="edit-hint translate">descriptive
                        only - displayed in homekit apps. Changes are only recognized after readding the bridge in the
                        app.</span></div>
                <div class="errorpanel translate" id="name_error">A device with this name already exists. Please change
                    the name!</div>
                <div class="input control flex-grow margin10">
                    <input class="full-size" type="text" id="name" />
                </div>
            </div>
            <div>
                <div><label class="translate" for="manufacturer">Manufacturer:</label><span class="edit-hint translate">descriptive
                        only - displayed in some homekit apps</span></div>
                <div class="input control flex-grow  margin10">
                    <input class="full-size" type="text" id="manufacturer" />
                </div>
            </div>
            <div>
                <div><label class="translate" for="model">Model:</label><span class="edit-hint translate">descriptive
                        only - displayed in some homekit apps</span></div>
                <div class="input controlflex-grow  margin10">
                    <input class="full-size" type="text" id="model" />
                </div>
            </div>
            <div>
                <div><label class="translate" for="serial">Serial:</label><span class="edit-hint translate">descriptive
                        only - displayed in some homekit apps</span></div>
                <div class="input controlflex-grow  margin10">
                    <input class="full-size" type="text" id="serial" />
                </div>
            </div>
            <div>
                <div><label class="translate" for="username">Username:</label><span class="edit-hint translate">needs
                        to be in form of a mac address, e.g: d8:be:54:e7:06:f8. <b>After changing this field, the
                            bridge needs to be reconfigured in the HomeKit database</b></span></div>
                <div class="input controlflex-grow  margin10">
                    <input class="full-size" type="text" id="username" />
                </div>
            </div>
            <div>
                <div><label class="translate" for="pincode">Pincode:</label><span class="edit-hint translate">needs to
                        be in the form of 123-45-678</span></div>
                <div class="input controlflex-grow  margin10">
                    <input class="full-size" type="text" id="pincode" />
                </div>
            </div>
            <div>
                <div><label class="translate" for="port">Port:</label><span class="edit-hint translate">0 = random free
                        port assigned by the operation system (default)</span></div>
                <div class="input controlflex-grow  margin10">
                    <input class="full-size" type="number" id="port" />
                </div>
            </div>
            <div>
                <div><label class="translate" for="verboseLogging">Verbose Logging:</label><span class="edit-hint translate">true
                        = redirect hap-node logging to adapter logging</span></div>
                <div class="input controlflex-grow  margin10">
                    <input class="" type="checkbox" id="verboseLogging" />
                </div>
            </div>
        </template>

        <template id="yahka_cameraConfig_template">
            <div class="frame">
                <div class="heading">
                    <span class="translate">Basic Properties</span>
                </div>
                <div class="content">
                    <div>
                        <div><label class="translate" for="enabled">Enabled:</label></div>
                        <div class="input control flex-grow margin10">
                            <input type="checkbox" id="enabled" />
                        </div>
                    </div>
                    <div>
                        <div><label class="translate" for="name">Device name:</label></div>
                        <div class="errorpanel translate" id="name_error">A device with this name already exists.
                            Please change the name!</div>
                        <div class="input control flex-grow margin10">
                            <input class="full-size" type="text" id="name" />
                        </div>
                    </div>
                    <div>
                        <div><label class="translate" for="manufacturer">Manufacturer:</label></div>
                        <div class="input control flex-grow  margin10">
                            <input class="full-size" type="text" id="manufacturer" />
                        </div>
                    </div>
                    <div>
                        <div><label class="translate" for="model">Model:</label></div>
                        <div class="input controlflex-grow  margin10">
                            <input class="full-size" type="text" id="model" />
                        </div>
                    </div>
                    <div>
                        <div><label class="translate" for="serial">Serial:</label></div>
                        <div class="input controlflex-grow  margin10">
                            <input class="full-size" type="text" id="serial" />
                        </div>
                    </div>
                    <div>
                        <div><label class="translate" for="username">Username:</label><span class="edit-hint translate">needs
                                to be in form of a mac address, e.g: d8:be:54:e7:06:f8. <b>After changing this field,
                                    the camera needs to be reconfigured in the HomeKit database</b></span></div>
                        <div class="input controlflex-grow  margin10">
                            <input class="full-size" type="text" id="username" />
                        </div>
                    </div>
                    <div>
                        <div><label class="translate" for="pincode">Pincode:</label><span class="edit-hint translate">needs
                                to be in the form of 123-45-678</span></div>
                        <div class="input controlflex-grow  margin10">
                            <input class="full-size" type="text" id="pincode" />
                        </div>
                    </div>
                    <div>
                        <div><label class="translate" for="port">Port:</label><span class="edit-hint translate">0 =
                                random free port assigned by the operation system (default)</span></div>
                        <div class="input controlflex-grow  margin10">
                            <input class="full-size" type="number" id="port" />
                        </div>
                    </div>
                </div>
            </div>

            <div class="frame">
                <div class="heading">
                    <span class="translate">Stream Properties</span>
                </div>

                <div class="content">
                    <div>
                        <div><label class="translate" for="source">Source:</label></div>
                        <div class="input control flex-grow margin10">
                            <input class="full-size" type="text" id="source" />
                        </div>
                    </div>
                    <div>
                        <div><label class="translate" for="codec">Codec:</label></div>
                        <div class="input control flex-grow  margin10">
                            <input class="full-size" type="text" id="codec" />
                        </div>
                    </div>
                    <div>
                        <div><label class="translate" for="numberOfStreams">Number of Streams:</label></div>
                        <div class="input controlflex-grow  margin10">
                            <input class="full-size" type="text" id="numberOfStreams" />
                        </div>
                    </div>
                    <div>
                        <div><label class="translate" for="maxWidth">maxWidth:</label></div>
                        <div class="input controlflex-grow  margin10">
                            <input class="full-size" type="text" id="maxWidth" />
                        </div>
                    </div>
                    <div>
                        <div><label class="translate" for="maxHeight">maxHeight:</label></div>
                        <div class="input controlflex-grow  margin10">
                            <input class="full-size" type="text" id="maxHeight" />
                        </div>
                    </div>
                    <div>
                        <div><label class="translate" for="maxFPS">maxFPS:</label></div>
                        <div class="input controlflex-grow  margin10">
                            <input class="full-size" type="text" id="maxFPS" />
                        </div>
                    </div>
                </div>
            </div>
            <div class="frame">
                <div class="heading">
                    <span class="translate">Advanced Settings</span>
                </div>

                <div class="content">
                    <div>
                        <div><label class="translate" for="ffmpeg_snapshot">FFMPEG Command Line - Snapshot:</label></div>
                        <div class="errorpanel" id="ffmpeg_snapshot_error"></div>
                        <div class="input control flex-grow margin10 flex-container-row">
                            <textarea rows=8 class="flex-grow" id="ffmpeg_snapshot"></textarea>
                            <div class="margin10"><span class="translate">Available replacers:</span> <br>
                                <ul class="simple-list blue-bullet replace-list">
                                    <li>${source}</li>
                                    <li>${width}</li>
                                    <li>${height}</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div>
                        <div><label class="translate" for="ffmpeg_stream">FFMPEG Command Line - Stream:</label></div>
                        <div class="errorpanel" id="ffmpeg_stream_error"></div>
                        <div class="input control flex-grow margin10 flex-container-row">
                            <textarea rows=8 class="flex-grow" id="ffmpeg_stream"></textarea>
                            <div class="margin10"><span class="translate">Available replacers:</span> <br>
                                <ul class="simple-list blue-bullet replace-list">
                                    <li>${codec}</li>
                                    <li>${fps}</li>
                                    <li>${width}</li>
                                    <li>${height}</li>
                                    <li>${bitrate}</li>
                                    <li>${videokey}</li>
                                    <li>${targetAddress}</li>
                                    <li>${targetVideoPort}</li>
                                </ul>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </template>

        <template id="yahka_device_service_panel">
            <div class="frame" id="yahka_service_panel">
                <div class="heading">
                    <span class="translate">Service: </span><span id="yahka_service_caption"></span>
                    <a href="#" class="place-right" id="yakha_delete_service"><span class="mif-cross fg-red"></span></a>
                </div>
                <div class="content">
                    <div class="flex-container-row flex-grow flex-align-baseline">
                        <div><label class="translate" for="service_name">Service name:</label></div>
                        <div class="input control flex-grow margin10">
                            <input class="full-size" type="text" id="service_name" />
                        </div>
                        <div><label class="translate" for="service_type">Service Type:</label></div>
                        <div class="input control flex-grow  margin10">
                            <select class="full-size" id="service_type"></select>
                        </div>
                        <div><label class="translate" for="service_subtype">Service Subtype:</label></div>
                        <div class="input controlflex-grow  margin10">
                            <input class="full-size" type="text" id="service_subtype" />
                        </div>
                    </div>
                    <div><span class="translate">Characteristics Table</span></div>
                    <div class="table" id="yahka_characteristic_table">
                        <div class="header row">
                            <div class="cell translate">Enabled</div>
                            <div class="cell translate">Name</div>
                            <div class="cell translate"></div>
                        </div>
                    </div>
                </div>
            </div>
        </template>

        <template id="yahka_characteristic_row">
            <div id="characteristic" class="row-group">
                <div class="row">
                    <div class="cell center">
                        <label class="input-control checkbox small-check">
                            <input type="checkbox" id="characteristic_enabled">
                            <span class="check"></span>
                        </label>
                    </div>
                    <div class="cell">
                        <span id="characteristic_name"></span>
                        <span class="place-right">InOut: </span>
                    </div>
                    <div class="cell">
                        <div class="input-control select full-width">
                            <select id="characteristic_inoutfunction"></select>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="cell center">
                    </div>
                    <div class="cell">
                    </div>
                    <div class="cell" id="characteristic_inoutparams_container">
                    </div>
                </div>

                <div class="row">
                    <div class="cell center">
                    </div>
                    <div class="cell center">
                        <span class="place-right">Conversion: </span>
                    </div>
                    <div class="cell">
                        <div class="input-control select full-width">
                            <select id="characteristic_conversionfunction"></select>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="cell center">
                    </div>
                    <div class="cell">
                    </div>
                    <div class="cell" id="characteristic_conversionparams_container">
                    </div>
                </div>
            </div>
        </template>
    </div>
    <div class="material-dialogs m">
        <div id="dialog-select-member" class="modal modal-fixed-footer">
            <div class="modal-content">
                <div class="row">
                    <div class="col s12 title"></div>
                </div>
                <div class="row">
                    <div class="col s12 dialog-content">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <a class="modal-action modal-close waves-effect waves-green btn btn-set"><i class="large material-icons">check</i><span
                        class="translate">Select</span></a>
                <a class="modal-action modal-close waves-effect waves-green btn btn-close"><i class="large material-icons">close</i><span
                        class="translate">Cancel</span></a>
            </div>
        </div>
    </div>
</body>


<template id="editor_single_state">
    <div class="table" id="yahka_characteristic_table">
        <div class="row">
            <div class="cell">
                <label class="translate">State:</label>
            </div>
            <div class="cell">
                <div class="input-control auto-height full-width">
                    <textarea id="textfield" rows=1></textarea>
                    <button class="input-control button id-selector"><span class="mif-more-horiz"></span></button>
                </div>
            </div>
        </div>
    </div>
</template>

<template id="editor_const">
    <div class="table" id="yahka_characteristic_table">
        <div class="row">
            <div class="cell">
                <label class="translate">Value:</label>
            </div>
            <div class="cell">
                <div class="input-control auto-height full-width">
                    <textarea id="textfield" rows=1></textarea>
                </div>
            </div>
        </div>
    </div>
</template>


<template id="editor_conversion_scale">
    <!-- <div>Explanation: <br/>
        $value is mapped to HomeKit with:  (homekitMin + ((homekitMax - homekitMin) / (ioBrokerMax - ioBrokerMin)) * ($value - ioBrokerMin))</br>
        $value is mapped to ioBroker with: (ioBrokerMin + ((ioBrokerMax - ioBrokerMin) / (homeKitMax - homeKitMin)) * ($value - homeKitMin))
    </div> -->
    <div class="table" id="yahka_characteristic_table">
        <div class="row">
            <div class="cell">
                <label class="translate">HomeKit Minimum:</label>
            </div>
            <div class="cell">
                <div class="input-control full-width">
                    <input type="number" id="hkMin"></input>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="cell">
                <label class="translate">HomeKit Maximum:</label>
            </div>
            <div class="cell">
                <div class="input-control full-width">
                    <input type="number" id="hkMax"></input>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="cell">
                <label class="translate">ioBroker Minimum:</label>
            </div>
            <div class="cell">
                <div class="input-control full-width">
                    <input type="number" id="ioMin"></input>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="cell">
                <label class="translate">ioBroker Maximum:</label>
            </div>
            <div class="cell">
                <div class="input-control full-width">
                    <input type="number" id="ioMax"></input>
                </div>
            </div>
        </div>
    </div>
</template>

<template id="editor_conversion_HomeMaticWindowCoveringTargetPosition">
    <div class="table" id="yahka_characteristic_table">
        <div class="row">
            <div class="cell">
                <label class="translate">Level Datapoint:</label>
            </div>
            <div class="cell">
                <div class="input-control auto-height full-width">
                    <textarea id="level" rows=1></textarea>
                    <button class="input-control button id-selector"><span class="mif-more-horiz"></span></button>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="cell">
                <label class="translate">Working Datapoint:</label>
            </div>
            <div class="cell">
                <div class="input-control auto-height full-width">
                    <textarea id="working" rows=1></textarea>
                    <button class="input-control button id-selector"><span class="mif-more-horiz"></span></button>
                </div>

            </div>
        </div>
    </div>
</template>

<template id="editor_conversion_script">
    <div>Explanation: use the variable <b>value</b> to access the sourcevalue. Example: <i>return value * 2;</i><br />
        <div class="table" id="yahka_characteristic_table">
            <div class="row">
                <div class="cell">
                    <label class="translate">To HomeKit:</label>
                </div>
                <div class="cell">
                    <span>function(value) {</span>
                    <div class="input-control auto-height full-width">
                        <textarea id="toHomeKit" rows=4></textarea>
                    </div>
                    <span>}</span>
                </div>
            </div>
            <div class="row">
                <div class="cell">
                    <label class="translate">To IOBroker:</label>
                </div>
                <div class="cell">
                    <span>function(value) {</span>
                    <div class="input-control auto-height full-width">
                        <textarea id="toIOBroker" rows=4></textarea>
                    </div>
                    <span>}</span>
                </div>
            </div>
        </div>
</template>

</html>